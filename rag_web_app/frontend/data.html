<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG-Eval-App — Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="flex flex-col min-h-screen">
  <!-- 80% width container for the grids -->
  <main class="w-full flex justify-center">
    <div class="w-full md:w-4/5 max-w-7xl mx-auto px-4">
      <!-- BEGIN: data grids -->
      <header class="w-full bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="text-xl font-semibold">RAG-Eval-App</div>
          <nav class="flex space-x-2">
            <a href="index.html" class="px-4 py-2 rounded-md bg-transparent text-gray-700 hover:bg-gray-100">Back to App</a>
          </nav>
        </div>
      </header>

      <main class="w-full max-w-3xl mt-8 p-6 bg-white rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold mb-4">Generate Groundtruth Data</h1>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select file (PDF / TXT)</label>
          <input id="gtFile" type="file" accept=".pdf,.txt" class="w-full" />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
          <div class="flex gap-2">
            <input id="gtSplit" type="checkbox" class="mt-1" /> <label for="gtSplit" class="text-sm">Split into QA pairs</label>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="generateBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Generate Groundtruth Data</button>
          <span id="gtStatus" class="text-sm text-gray-600"></span>
        </div>

        <div id="gtOutput" class="mt-6 text-sm text-gray-800"></div>

        <!-- Preview Container -->
        <div id="previewContainer" class="mt-6 hidden">
          <h2 class="text-xl font-semibold mb-4">Preview</h2>
          <div id="gtPreview" class="space-y-4"></div>
        </div>

        <!-- Download Link -->
        <div id="downloadLinkContainer" class="mt-4 hidden">
          <a id="downloadLink" href="#" class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Download Groundtruth File
          </a>
        </div>
      </main>

      <script>
        const API_BASE = "http://localhost:8000";
        const generateBtn = document.getElementById('generateBtn');
        const gtFile = document.getElementById('gtFile');
        const gtStatus = document.getElementById('gtStatus');
        const gtOutput = document.getElementById('gtOutput');
        const gtPreview = document.getElementById('gtPreview');
        const previewContainer = document.getElementById('previewContainer');
        const downloadLink = document.getElementById('downloadLink');
        const gtSplit = document.getElementById('gtSplit');

        generateBtn.addEventListener('click', async () => {
          const file = gtFile.files?.[0];
          if (!file) {
            gtStatus.textContent = '❌ Please select a file first.';
            return;
          }

          gtStatus.textContent = '⏳ Generating...';
          gtOutput.classList.add('hidden');
          previewContainer.classList.add('hidden');
          gtPreview.innerHTML = '';

          try {
            const form = new FormData();
            form.append('file', file);
            form.append('split_into_qa', gtSplit.checked ? '1' : '0');

            console.log('Uploading file to:', `${API_BASE}/generate_groundtruth`);
            console.log('File:', file.name, file.size);

            const res = await fetch(`${API_BASE}/generate_groundtruth`, {
              method: 'POST',
              body: form
            });

            console.log('Response status:', res.status);
            const text = await res.text();
            console.log('Response text:', text);

            let data;
            try {
              data = JSON.parse(text);
            } catch (parseErr) {
              console.error('JSON parse error:', parseErr);
              gtStatus.textContent = '❌ Invalid response from server';
              gtOutput.classList.remove('hidden');
              gtOutput.textContent = text;
              return;
            }

            console.log('Parsed response:', data);

            if (!res.ok || !data.ok) {
              gtStatus.textContent = `❌ ${data.message || 'Generation failed'}`;
              gtOutput.classList.remove('hidden');
              gtOutput.textContent = JSON.stringify(data, null, 2);
              return;
            }

            gtStatus.textContent = `✅ Generated ${data.preview?.length || 0} goldens`;

            // Set download link
            if (data.golden_file) {
              downloadLink.href = `${API_BASE}/download_groundtruth?file=${encodeURIComponent(data.golden_file)}`;
              downloadLink.download = `${file.name.split('.')[0]}.goldens.json`;
              document.getElementById('downloadLinkContainer').classList.remove('hidden');
            }

            // Display preview
            gtPreview.innerHTML = '';
            if (data.preview && Array.isArray(data.preview)) {
              data.preview.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'p-3 bg-white border border-blue-100 rounded';
                card.innerHTML = `
                  <div class="mb-2">
                    <strong>Q${idx + 1}:</strong> <span class="text-gray-700">${escapeHtml(item.question || 'N/A')}</span>
                  </div>
                  <div class="mb-2">
                    <strong>A:</strong> <span class="text-gray-600 text-sm">${escapeHtml((item.answer || 'N/A').substring(0, 120))}...</span>
                  </div>
                  <div>
                    <strong>Fact:</strong> <span class="text-gray-600 text-sm">${escapeHtml((item.fact || 'N/A').substring(0, 120))}...</span>
                  </div>
                `;
                gtPreview.appendChild(card);
              });
            }

            previewContainer.classList.remove('hidden');

            // Show raw JSON for debugging
            gtOutput.classList.remove('hidden');
            gtOutput.textContent = JSON.stringify(data.preview, null, 2);

          } catch (err) {
            console.error('Fetch error:', err);
            gtStatus.textContent = `❌ Error: ${err.message}`;
            gtOutput.classList.remove('hidden');
            gtOutput.textContent = `Error Type: ${err.name}\nMessage: ${err.message}\n\nNote: Make sure backend is running on http://localhost:8000`;
          }
        });

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      </script>
    </div>
  </main>
</body>
</html>